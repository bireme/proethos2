<div class='block'>
    <div class='row'>
        <div class="col-md-12">
            <h2 class='sub-header toggle-block'>
                <small class='pull-right'>
                    <i class='glyphicon glyphicon-minus'></i>
                </small>
                
                {% trans %}Team{% endtrans %}
            </h2>
        </div>
    </div>

    <form class='form' method='POST' id='form-team' action='{{ path("protocol_new_team_member", {protocol_id: protocol.id}) }}'>

        <input type="hidden" name="token" value="{{ csrf_token('add-member') }}"/>

        <div class='row'>
            <div class="col-md-12">
                <table class='table table-hover table-condensed' id='table-team'>
                    
                    <thead>
                        <tr>
                            <th width="40%">{% trans %}Name{% endtrans %}</th>
                            <th>{% trans %}E-mail{% endtrans %}</th>
                            <th>{% trans %}Institution{% endtrans %}</th>
                            <th>{% trans %}Role{% endtrans %}</th>
                            <th>{% trans %}Country{% endtrans %}</th>
                            <th>{% trans %}Main?{% endtrans %}</th>
                            <th>{% trans %}Actions{% endtrans %}</th>
                        </tr>
                    </thead>
                    
                    <tbody>
                        <tr>
                            <td data-label="{% trans %}Name{% endtrans %}">{{ protocol.mainSubmission.owner.name }}</td>
                            <td data-label="{% trans %}E-mail{% endtrans %}"><a href='' onclick="copiarHref({{ protocol.mainSubmission.owner.email }}); return false;">{{ protocol.mainSubmission.owner.email }}</a></td>
                            <td data-label="{% trans %}Institution{% endtrans %}">{{ protocol.mainSubmission.owner.institution }}</td>
                            <td data-label="{% trans %}Role{% endtrans %}">{{ protocol.mainSubmission.owner.submissionTeamRole(protocol.mainSubmission) }}</td>
                            <td data-label="{% trans %}Country{% endtrans %}">{{ protocol.mainSubmission.owner.country }}</td>
                            <td data-label="{% trans %}Main?{% endtrans %}"><label class='label label-success'>{% trans %}Yes{% endtrans %}</label></td>
                            <td data-label="{% trans %}Actions{% endtrans %}"></td>
                        </tr>

                        {% for team_user in protocol.mainSubmission.team %}
                            <tr data-id="{{ team_user.id }}">
                                <td data-label="{% trans %}Name{% endtrans %}">
                                    <input type='hidden' name='team_user[]' value='{{ team_user.id }}'>
                                    {{ team_user.name }}
                                </td>
                                <td data-label="{% trans %}E-mail{% endtrans %}"><a href='{{ team_user.email }}'>{{ team_user.email }}</a></td>
                                <td data-label="{% trans %}Institution{% endtrans %}">{{ team_user.institution }}</td>
                                <td data-label="{% trans %}Role{% endtrans %}">
                                    <input type='hidden' name='team_role[{{ team_user.id }}]' value='{{ team_user.submissionTeamRole(protocol.mainSubmission) }}'>
                                    {{ team_user.submissionTeamRole(protocol.mainSubmission) }}
                                </td>
                                <td data-label="{% trans %}Country{% endtrans %}">{{ team_user.country }}</td>
                                <td data-label="{% trans %}Main?{% endtrans %}"><label class='label label-default'>{% trans %}No{% endtrans %}</label></td>
                                <td data-label="{% trans %}Actions{% endtrans %}">
                                    {% if 'secretary' in app.user.getRolesSlug %}
                                        <a href='#' class='btn btn-default btn-xs button-make-owner' data-toggle="tooltip" data-placement="top" title="{% trans %}Make this investigator owner of this submission{% endtrans %}"><i class='glyphicon glyphicon-star'></i></a>
                                        <a href='#' class='btn btn-default btn-xs button-remove-team' data-toggle="tooltip" data-placement="top" title="{% trans %}Remove this investigator.{% endtrans %}"><i class='glyphicon glyphicon-trash'></i></a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                        
                        {% for team_user in submission_team %}
                            {% set unique_id = '_' ~ random() %}
                            <tr data-id="{{ unique_id }}">
                                <td>
                                    <input type='hidden' name='new_team_user[]' value='{{ unique_id }}'>
                                    {{ team_user.name }}
                                </td>
                                <td>
                                    <input type='hidden' name='team_email[{{ unique_id }}]' value='{{ team_user.email }}'>
                                    <a href='{{ team_user.email }}'>{{ team_user.email }}</a></td>
                                <td>
                                    <input type='hidden' name='team_institution[{{ unique_id }}]' value='{{ team_user.institution }}'>
                                    {{ team_user.institution }}</td>
                                <td>
                                    <input type='hidden' name='team_role[{{ unique_id }}]' value='{{ team_user.role }}'>
                                    {{ team_user.role }}
                                </td>
                                <td><input type='hidden' name='team_name[{{ unique_id }}]' value='{{ team_user.name }}'></td>
                                <td><label class='label label-default'>{% trans %}No{% endtrans %}</label></td>
                                <td>
                                    {% if 'secretary' in app.user.getRolesSlug %}
                                        <a href='#' class='btn btn-default btn-xs button-remove-team' data-toggle="tooltip" data-placement="top" title="{% trans %}Remove this investigator.{% endtrans %}"><i class='glyphicon glyphicon-trash'></i></a>
                                    {% endif %}
                                </td>
                            </tr>
                        {% endfor %}
                    </tbody>
                </table>
                
                {% if 'secretary' in app.user.getRolesSlug %}
                    <a href='#' class='btn btn-default' data-toggle="modal" data-target="#modal-new-investigator">
                        {% trans %}Add Investigator{% endtrans %}
                    </a>
                {% endif %}
            </div>
        </div>

    </form>

</div>

{% if 'secretary' in app.user.getRolesSlug %}
    <div class='block'>
        <div class='row'>
            <div class="col-md-12">
                <h2 class='sub-header toggle-block'>
                    <small class='pull-right'>
                        <i class='glyphicon glyphicon-minus'></i>
                    </small>
                    
                    {% trans %}Contacts{% endtrans %}:
                </h2>
            </div>
        </div>

        <div class='row'>
            <div class="col-md-12">
                <form method="POST" id='form-contacts' action="{{ path("protocol_show_protocol", {protocol_id: protocol.id}) }}'">
                    <input type="hidden" name="token" value="{{ csrf_token('add-contacts') }}"/>
                    <div class="form-group form-contacts">
                        <input name="contacts" placeholder="{% trans %}insert emails here{% endtrans %}" value="{{ protocol.contacts }}">
                    </div>
                    <button type="submit" class="btn btn-default">{% trans %}Save Contacts{% endtrans %}</button>
                </form>
            </div>
        </div>
    </div>
{% endif %}

<div class='block'>
    <div class='row'>
        <div class="col-md-12">
            <h2 class='sub-header toggle-block'>
                <small class='pull-right'>
                    <i class='glyphicon glyphicon-minus'></i>
                </small>
                
                {% trans %}File submission{% endtrans %}:
            </h2>
        </div>
    </div>

    <div class='row'>
        <div class="col-md-12">
            <table class='table table-hover table-condensed' id='table-attachment'>
                
                <thead>
                    <tr>
                        <th>{% trans %}Type{% endtrans %}</th>
                        <th>{% trans %}Original Submission{% endtrans %}</th>
                        <th>{% trans %}Submitted by{% endtrans %}</th>
                        <th>{% trans %}File name{% endtrans %}</th>
                        <th>{% trans %}Date & Time{% endtrans %}</th>
                        <th>{% trans %}Priority{% endtrans %}</th>
                        <th>{% trans %}Actions{% endtrans %}</th>
                    </tr>
                </thead>
                
                <tbody>
                    {% for file in protocol.mainSubmission.attachments if not file.isMonitoringAction %}
                        {% set class = '' %}
                        {% if file.flag == 1 %}
                            {% set class = 'text-danger' %}
                        {% elseif file.flag == 2 %}
                            {% set class = 'text-warning' %}
                        {% elseif file.flag == 3 %}
                            {% set class = 'text-primary' %}
                        {% elseif file.flag == 4 %}
                            {% set class = 'text-success' %}
                        {% endif %}

                        {% set text = '' %}
                        {% if file.flag == 1 %}
                            {% set text = 'Required' %}
                        {% elseif file.flag == 2 %}
                            {% set text = 'Supporting document' %}
                        {% elseif file.flag == 3 %}
                            {% set text = 'Reference only' %}
                        {% elseif file.flag == 4 %}
                            {% set text = 'Final version' %}
                        {% endif %}

                        <tr>
                            <td data-label="{% trans %}Type{% endtrans %}">{{ file.uploadType }}</td>
                            <td data-label="{% trans %}Original Submission{% endtrans %}">{{ file.submissionNumber }}</td>
                            <td data-label="{% trans %}Submitted by{% endtrans %}">{{ file.user }}</td>
                            <td data-label="{% trans %}File name{% endtrans %}">{{ file }}</td> 
                            <td data-label="{% trans %}Date & Time{% endtrans %}">{{ file.created|date("d/m/Y H:i") }}</td>
                            <td class="{{ class }}" data-label="{% trans %}Priority{% endtrans %}"><b>{{ text|trans }}</b></td>
                            <td data-label="{% trans %}Actions{% endtrans %}">
                                <a href='{{ path("protocol_upload", {'upload_id': file.id }) }}' class='btn btn-default btn-xs' target="_blank">
                                    <i class='glyphicon glyphicon-eye-open'></i>
                                </a>
                                {% if is_granted("ROLE_USER") and 'secretary' in app.user.rolesSlug %}
                                    <a href='#' class='btn btn-default btn-xs button-add-attachment-flag' data-id='{{ file.id }}' data-toggle="modal" data-target="#modal-add-attachment-flag">
                                        <i class='glyphicon glyphicon-tag'></i>
                                    </a>
                                    {% if file.uploadType.slug not in ['protocol', 'opinion'] %}
                                        <a href='#' class='btn btn-default btn-xs button-delete-attachment' data-id='{{ file.id }}' data-toggle="modal" data-target="#modal-delete-attachment">
                                            <i class='glyphicon glyphicon-trash'></i>
                                        </a>
                                    {% endif %}
                                {% endif %}
                            </td> 
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
            
            {% if is_granted("ROLE_USER") and 'secretary' in app.user.rolesSlug %}
                <a href='{{ path("protocol_new_attachment", {'protocol_id': protocol.id }) }}' class='btn btn-default mb-3' data-toggle="modal" data-target="#modal-new-file">{% trans %}New Attachment{% endtrans %}</a>
            {% endif %}
            {% if is_granted("ROLE_USER") and ('secretary' in app.user.rolesSlug or 'member-of-committee' in app.user.rolesSlug)  %}
                <a href='{{ path("protocol_generate_report", {'protocol_id': protocol.id}) }}' class='btn btn-default mb-3' target='_blank'>{% trans %}Create Report{% endtrans %}</a>
            {% endif %}
        </div>
    </div>
</div>

<div class='block'>
    <div class='row'>
        <div class="col-md-12">
            <h2 class='sub-header toggle-block'>
                <small class='pull-right'>
                    <i class='glyphicon glyphicon-minus'></i>
                </small>
                
                {% trans %}History{% endtrans %}:
            </h2>
        </div>
    </div>

    <div class='row'>
        <div class="col-md-12">
            <table class='table table-hover table-condensed'>
                
                <thead>
                    <tr>
                        <th>{% trans %}Date & Time{% endtrans %}</th>
                        <th>{% trans %}Message{% endtrans %}</th>
                    </tr>
                </thead>
                
                <tbody>
                    {% for history in protocol.history %}
                        <tr>
                           <td data-label="{% trans %}Date & Time{% endtrans %}">{{ history.created|date("d/m/Y H:i:s") }}</td>
                           <td data-label="{% trans %}Message{% endtrans %}">{{ history.message }}</td> 
                        </tr>
                    {% endfor %}
                </tbody>
            </table>
        </div>
    </div>
</div>

{% if 'investigator' in app.user.getRolesSlug or 'secretary' in app.user.getRolesSlug or 'administrator' in app.user.getRolesSlug %}
    <div class='block'>
        <div class='row'>
            <div class="col-md-12">
                <h2 class='sub-header toggle-block'>
                    <small class='pull-right'>
                        <i class='glyphicon glyphicon-minus'></i>
                    </small>
                    
                    {% if 'member-of-committee' in app.user.getRolesSlug %}
                        {% trans %}Correspondence{% endtrans %} ({% trans %}for use by investigators only{% endtrans %})
                    {% else %}
                        {% trans %}Correspondence{% endtrans %}
                    {% endif %}
                </h2>
            </div>
        </div>

        <div class='row'>
            <div class="col-md-12">
                <table class='table table-hover table-condensed table-comment'>
                    <thead>
                        <tr>
                            <th width="15%">{% trans %}Date & Time{% endtrans %}</th>
                            <th width="15%">{% trans %}Author{% endtrans %}</th>
                            <th width="15%">{% trans %}Confidential{% endtrans %}</th>
                            <th>{% trans %}Message{% endtrans %}</th>
                            <th>{% trans %}Actions{% endtrans %}</th>
                        </tr>
                    </thead>
                     
                    <tbody>
                        {% for comment in protocol.comment %}
                            {% if 'member-of-committee' != comment.role %}
                                {% if not comment.isConfidential or 'investigator' not in app.user.getRolesSlug or not protocol.mainSubmission.isOwner(app.user) %}
                                    <tr>
                                        <td data-label="{% trans %}Date & Time{% endtrans %}">{{ comment.created|date('d/m/Y H:i:s') }}</td>
                                        <td data-label="{% trans %}Author{% endtrans %}">{{ comment.owner }}</td> 
                                        <td data-label="{% trans %}Confidential{% endtrans %}">{% if comment.isConfidential %}<i class='glyphicon glyphicon-ok'></i>{% endif %}</td>
                                        <td data-label="{% trans %}Message{% endtrans %}">{{ comment.message|nl2br }}</td>
                                        <td data-label="{% trans %}Actions{% endtrans %}">
                                            {% if comment.filename %}
                                                {% set filehash = comment.filename|split('_')[0] %}
                                                <a href='{{ path("protocol_comment_upload", {'comment_id': comment.id }) }}' class='btn btn-default btn-xs' data-toggle="tooltip" data-placement="top" title="{{ comment.realFilename }}" target="_blank"><i class='glyphicon glyphicon-eye-open'></i></a>
                                            {% endif %}
                                            {% if is_granted("ROLE_USER") and 'secretary' in app.user.rolesSlug %}
                                                <a href='#' class='btn btn-default btn-xs button-delete-comment' data-id='{{ comment.id }}' data-toggle="modal" data-target="#modal-delete-comment"><i class='glyphicon glyphicon-trash'></i></a>
                                            {% endif %}
                                        </td>
                                    </tr>
                                {% endif %}
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>

                {% if 'administrator' in app.user.getRolesSlug or 'secretary' in app.user.getRolesSlug or 'investigator' in app.user.getRolesSlug %}
                    <a href='#' class='btn btn-default' data-toggle="modal" data-target="#modal-new-comment">{% trans %}New Comment{% endtrans %}</a>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}

{% if 'member-of-committee' in app.user.getRolesSlug or 'secretary' in app.user.getRolesSlug or 'administrator' in app.user.getRolesSlug %}
    <div class='block'>
        <div class='row'>
            <div class="col-md-12">
                <h2 class='sub-header toggle-block'>
                    <small class='pull-right'>
                        <i class='glyphicon glyphicon-minus'></i>
                    </small>
                    
                    {% if 'member-of-committee' in app.user.getRolesSlug %}
                        {% trans %}Committee Communication Section{% endtrans %} ({% trans %}for use by committee members only{% endtrans %} - {% trans %}not visible to investigators{% endtrans %})
                    {% else %}
                        {% trans %}Committee Communication Section{% endtrans %}
                    {% endif %}
                </h2>
            </div>
        </div>

        <div class='row'>
            <div class="col-md-12">
                <table class='table table-hover table-condensed table-comment'>
                    <thead>
                        <tr>
                            <th width="15%">{% trans %}Date & Time{% endtrans %}</th>
                            <th width="15%">{% trans %}Author{% endtrans %}</th>
                            <th>{% trans %}Message{% endtrans %}</th>
                            <th>{% trans %}Actions{% endtrans %}</th>
                        </tr>
                    </thead>
                     
                    <tbody>
                        {% for comment in protocol.comment %}
                            {% if 'member-of-committee' == comment.role %}
                                <tr>
                                    <td data-label="{% trans %}Date & Time{% endtrans %}">{{ comment.created|date('d/m/Y H:i:s') }}</td>
                                    <td data-label="{% trans %}Author{% endtrans %}">{{ comment.owner }}</td> 
                                    <td data-label="{% trans %}Message{% endtrans %}">{{ comment.message|nl2br }}</td>
                                    <td data-label="{% trans %}Actions{% endtrans %}">
                                        {% if comment.filename %}
                                            <a href='{{ path("protocol_comment_upload", {'comment_id': comment.id }) }}' class='btn btn-default btn-xs' data-toggle="tooltip" data-placement="top" title="{{ comment.realFilename }}" target="_blank"><i class='glyphicon glyphicon-eye-open'></i></a>
                                        {% endif %}
                                        {% if is_granted("ROLE_USER") and 'secretary' in app.user.rolesSlug %}
                                            <a href='#' class='btn btn-default btn-xs button-delete-comment' data-id='{{ comment.id }}' data-toggle="modal" data-target="#modal-delete-comment"><i class='glyphicon glyphicon-trash'></i></a>
                                        {% endif %}
                                    </td> 
                                </tr>
                            {% endif %}
                        {% endfor %}
                    </tbody>
                </table>

                {% if 'member-of-committee' in app.user.getRolesSlug %}
                    <a href='#' class='btn btn-default' data-toggle="modal" data-target="#modal-new-committee-comment">{% trans %}New Comment{% endtrans %}</a>
                {% endif %}
            </div>
        </div>
    </div>
{% endif %}

<!-- Modal New Comment -->
<div class="modal fade" id="modal-new-comment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <form enctype="multipart/form-data" method="POST" action='{{ path('protocol_new_comment', {protocol_id: protocol.id}) }}'>

            <input type="hidden" name="token" value="{{ csrf_token('add-comment') }}"/>
            <input type="hidden" name="new-comment-role" value=""/>
            <input type="hidden" name="MAX_FILE_SIZE" value="{{ 50*1024*1024 }}" />

            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">{% trans %}New Comment{% endtrans %}</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="textarea-new-comment-message">{% trans %}Message{% endtrans %}:</label> 
                        <a href="{{ path("crud_admin_help_show", {help_id: 126} ) }}" data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                        <textarea class='form-control' rows='4' name='new-comment-message' id='textarea-new-comment-message' required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="input-file-1">{% trans %}File{% endtrans %}:</label> 
                        <input type='file' class='form-control' id="input-file-1" name="file">
                    </div>

                    {# code that discover if should show the confidential option #}
                    {% set is_show_confiential_field = false %}
                    {% for role in app.user.getRolesSlug %}
                        {% if role in ['secretary'] %}
                            {% set is_show_confiential_field = true %}
                        {% endif %}
                    {% endfor %}

                    {% if is_show_confiential_field and not protocol.mainSubmission.isOwner(app.user) %}
                        <div class="form-group">
                            <div class="checkbox">
                                <label for="checkbox-new-comment-is-confidential">
                                    <input type="checkbox" name='new-comment-is-confidential' id='checkbox-new-comment-is-confidential' value="yes">{% trans %}Is this a confidential comment?{% endtrans %}
                                    <a href="{{ path("crud_admin_help_show", {help_id: 184} ) }}" data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                </label>
                            </div>
                        </div>
                    {% endif %}
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                    <button type="submit" class="btn btn-primary">{% trans %}Save{% endtrans %}</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal New Comment - Committee Communication Section -->
<div class="modal fade" id="modal-new-committee-comment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <form enctype="multipart/form-data" method="POST" action='{{ path('protocol_new_comment', {protocol_id: protocol.id}) }}'>

            <input type="hidden" name="token" value="{{ csrf_token('add-comment') }}"/>
            <input type="hidden" name="new-comment-role" value="member-of-committee"/>
            <input type="hidden" name="MAX_FILE_SIZE" value="{{ 50*1024*1024 }}" />

            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">{% trans %}New Comment{% endtrans %}</h4>
                </div>
                <div class="modal-body">
                    <div class="form-group">
                        <label for="textarea-new-comment-message">{% trans %}Message{% endtrans %}:</label> 
                        <a href="{{ path("crud_admin_help_show", {help_id: 126} ) }}" data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                        <textarea class='form-control' rows='4' name='new-comment-message' id='textarea-new-comment-message' required></textarea>
                    </div>

                    <div class="form-group">
                        <label for="input-file-2">{% trans %}File{% endtrans %}:</label> 
                        <input type='file' class='form-control' id="input-file-2" name="file">
                    </div>
                </div>
                
                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                    <button type="submit" class="btn btn-primary">{% trans %}Save{% endtrans %}</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Confirm Delete Comment -->
<div class="modal fade" id="modal-delete-comment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <form method="POST" id='form-delete-comment' action="{{ path("protocol_new_comment", {'protocol_id': protocol.id }) }}">

            <input type="hidden" name="token" value="{{ csrf_token('delete-comment') }}"/>
            <input type="hidden" name="delete-comment-id" id='hidden-delete-comment' value="" />

            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">{% trans %}Delete Comment{% endtrans %}</h4>
                </div>

                <div class="modal-body">
                    <p>{% trans %}Do you confirm the exclusion of this comment?{% endtrans %}</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                    <button type="submit" class="btn btn-danger">{% trans %}Confirm{% endtrans %}</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Novo Arquivo -->
<div class="modal fade" id="modal-new-file" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content"></div>
    </div>
</div>
    
<!-- Modal Confirmar Exclusão -->
<div class="modal fade" id="modal-delete-attachment" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <form method="POST" id='form-delete-attachment' action="{{ path("protocol_new_attachment", {'protocol_id': protocol.id }) }}">

            <input type="hidden" name="token" value="{{ csrf_token('delete-attachment') }}"/>
            <input type="hidden" name="delete-attachment-id" id='hidden-delete-attachment' value="" />

            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">{% trans %}Delete Attachment{% endtrans %}</h4>
                </div>

                <div class="modal-body">
                    <p>{% trans %}Do you confirm the exclusion of this attachment?{% endtrans %}</p>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                    <button type="submit" class="btn btn-danger">{% trans %}Confirm{% endtrans %}</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Add Attachment Flag -->
<div class="modal fade" id="modal-add-attachment-flag" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <form method="POST" id='form-add-attachment-flag' action="{{ path("protocol_new_attachment", {'protocol_id': protocol.id }) }}">

            <input type="hidden" name="token" value="{{ csrf_token('add-attachment-flag') }}"/>
            <input type="hidden" name="add-attachment-flag-id" id='hidden-attachment-flag' value="" />

            <div class="modal-content">
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel">{% trans %}Add Flag{% endtrans %}</h4>
                </div>

                <div class="modal-body">
                    <div class="form-group">
                        <label for="select-add-attachment-flag">{% trans %}Flag{% endtrans %}:</label>
                        <select class='form-control' name='add-attachment-flag' id='select-add-attachment-flag'>
                            <option value="">-</option>
                            <option value="1">{% trans %}Required{% endtrans %}</option>
                            <option value="2">{% trans %}Supporting document{% endtrans %}</option>
                            <option value="3">{% trans %}Reference only{% endtrans %}</option>
                            <option value="4">{% trans %}Final version{% endtrans %}</option>
                        </select>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                    <button type="submit" class="btn btn-primary">{% trans %}Send{% endtrans %}</button>
                </div>
            </div>
        </form>
    </div>
</div>

<!-- Modal Novo Investigador -->
<div class="modal fade" id="modal-new-investigator" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
    <div class="modal-dialog" role="document">
        <div class="modal-content">
            <form class='form' id='form-new-team'>
                <div class="modal-header">
                    <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                    <h4 class="modal-title" id="myModalLabel" style="display: inline;">{% trans %}Add Investigator{% endtrans %}</h4>
                    <a href="{{ path("crud_admin_help_show", {help_id: 224} ) }}" data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                </div>

                <div class="modal-body">
                    <ul class="nav nav-tabs">
                        <li id="modal-tab1" class="active"><a data-toggle="tab" href="#tab1">{% trans %}Select Investigator{% endtrans %}</a></li>
                        <li id="modal-tab2"><a data-toggle="tab" href="#tab2">{% trans %}New Investigator{% endtrans %}</a></li>
                    </ul>

                    <div class="tab-content">
                        <div id="tab1" class="tab-pane fade in active">
                            <div class="form-group">
                                <label for="">{% trans %}E-mail{% endtrans %}:</label>
                                <select class='form-control selectpicker' data-live-search="true" name='team-email' id='select-team-email'>
                                    <option value="">-</option>
                                    {% for user in users %}
                                        {% if protocol.mainSubmission.owner.email != user.email and user not in protocol.mainSubmission.team %}
                                            <option value="{{ user.id }}||{{ user.name }}||{{ user.country }}||{{ user.institution }}">{{ user.email }}</option>
                                        {% endif %}
                                    {% endfor %}
                                </select>
                            </div>

                            <div class="form-group">
                                <label for="">{% trans %}Name{% endtrans %}:</label>
                                <input type='text' class='form-control' name='team-name' readonly="">
                            </div>

                            <div class="form-group">
                                <label for="">{% trans %}Institution{% endtrans %}:</label>
                                <input type='text' class='form-control' name='team-institution' readonly="">
                            </div>

                            <div class="form-group">
                                <label for="">{% trans %}Role{% endtrans %}:</label>
                                <input type='text' class='form-control' name='team-role' value="">
                            </div>
                        </div>

                        <div id="tab2" class="tab-pane fade">
                            <div class="form-group required">
                                <label for="">{% trans %}E-mail{% endtrans %}:</label>
                                <input type='text' class='form-control' id='new-team-email' name='new-team-email' value="" required>
                            </div>

                            <div class="form-group required">
                                <label for="">{% trans %}Name{% endtrans %}:</label>
                                <input type='text' class='form-control' id='new-team-name' name='new-team-name' value="" required>
                            </div>

                            <div class="form-group">
                                <label for="">{% trans %}Institution{% endtrans %}:</label>
                                <input type='text' class='form-control' name='new-team-institution' value="">
                            </div>

                            <div class="form-group">
                                <label for="">{% trans %}Role{% endtrans %}:</label>
                                <input type='text' class='form-control' name='new-team-role' value="">
                            </div>
                        </div>
                    </div>
                </div>

                <div class="modal-footer">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                    <button type="submit" id='team-submit' class="btn btn-primary disabled" data-dismiss="modal">{% trans %}Save{% endtrans %}</button>
                </div>

                <div class="modal-footer hide">
                    <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                    <button type="submit" id='new-team-submit' class="btn btn-primary disabled" data-dismiss="modal">{% trans %}Save{% endtrans %}</button>
                </div>
            </form>
        </div>
    </div>
</div>

{% block script %}
    <script>
        // toggles de meta blocks
        $(function() {
            // $('[name=contacts]').tagify();
            var element = document.querySelector('[name=contacts]');
            new Tagify(element, {
                // email address validation
                pattern: /^(([^<>()\[\]\\.,;:\s@"]+(\.[^<>()\[\]\\.,;:\s@"]+)*)|(".+"))@((\[[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\.[0-9]{1,3}\])|(([a-zA-Z\-0-9]+\.)+[a-zA-Z]{2,}))$/
            });

            $("body").on("click", ".toggle-block", function(e){
                // find and toggle all rows of block
                block = $(this).parents('.block');
                first_row = $(this).parents('.row');
                block.find('.row').toggle();

                // turns visible the title row and toggle the icon
                first_row.show();
                i = first_row.find('i')
                if(i.hasClass('glyphicon-minus')) {
                    first_row.find('i').removeClass('glyphicon-minus');
                    first_row.find('i').addClass('glyphicon-plus');
                } else {
                    first_row.find('i').removeClass('glyphicon-plus');
                    first_row.find('i').addClass('glyphicon-minus');
                }
            });

            // hide all blocks on the load page
            $(".toggle-block").each(function(){
                $(this).trigger('click');     
            });

            $(".table-comment").on("click", ".button-delete-comment", function(e){
                var id = $(this).data('id');
                $("#hidden-delete-comment").val(id);
            });

            $('#modal-delete-comment').on('hidden.bs.modal', function () {
                $("#hidden-delete-comment").val("");
            });

            $("#table-attachment").on("click", ".button-delete-attachment", function(e){
                var id = $(this).data('id');
                $("#hidden-delete-attachment").val(id);
            });

            $('#modal-delete-attachment').on('hidden.bs.modal', function () {
                $("#hidden-delete-attachment").val("");
            });

            $("#select-add-attachment-flag").selectpicker();

            $("#table-attachment").on("click", ".button-add-attachment-flag", function(e){
                var id = $(this).data('id');
                $("#hidden-attachment-flag").val(id);
            });

            $('#modal-add-attachment-flag').on('hidden.bs.modal', function () {
                $("#hidden-attachment-flag").val("");
            });
        });

        $(function(){

            $team = {};

            $("#select-team-email").change(function() {
                user = $("#select-team-email option:selected").val();
                email = $("#select-team-email option:selected").text();
                if(user.length > 0) {

                    user = user.split("||");

                    id = parseInt(user[0]);
                    name = user[1];
                    country = user[2];
                    institution = user[3];
                    role = $("#form-new-team input[name='team-role']").val();

                    $team[id] = {name: name, email: email, country: country, institution: institution, role: role};

                    $("#form-new-team input[name='team-name']").val(name);
                    $("#form-new-team input[name='team-institution']").val(institution);
                    $("#team-submit").removeClass('disabled');
                } else {
                    $("#team-submit").addClass('disabled');
                }
            });

            $(document).on('keypress click', '#team-submit', function(e){
                e.preventDefault();

                for(id in $team) {
                    user = $team[id];

                    string =  "<tr>"
                    string += "<td><input type='hidden' name='team_user[]' value='"+ id +"'>"+ user['name'] +"</td>"
                    string += "<td><a href='mailto:"+ user['email'] +"'>"+ user['email'] +"</a></td>"
                    string += "<td>"+ user['institution'] +"</td>"
                    string += "<td><input type='hidden' name='team_role["+ id +"]' value='"+ user['role'] +"'>"+ role +"</td>"
                    string += "<td>"+ user['country'] +"</td>"
                    string += "<td><label class='label label-default'>{% trans %}No{% endtrans %}</label></td>"
                    string += "<td><a href='#' class='btn btn-default btn-xs button-remove-team'><i class='glyphicon glyphicon-trash'></i></a></td>"
                    string += "</tr>";

                    $("#table-team tbody").append(string);
                    $team = {};

                    form = $("#form-team");
                    form.submit();
                }
            });

            $("#new-team-email, #new-team-name").blur(function() {
                email = $("#new-team-email").val();
                name = $("#new-team-name").val();

                if ( email && name ) {
                    $("#new-team-submit").removeClass('disabled');
                } else {
                    $("#new-team-submit").addClass('disabled');
                }
            });

            $(document).on('keypress click', '#new-team-submit', function(e){
                e.preventDefault();

                $team = {};

                var unique_id = function () {
                    // Math.random should be unique because of its seeding algorithm.
                    // Convert it to base 36 (numbers + letters), and grab the first 9 characters after the decimal.
                    return '_' + Math.random().toString(36).substr(2, 9);
                };

                id = unique_id();
                email = $("#form-new-team input[name='new-team-email']").val();
                name = $("#form-new-team input[name='new-team-name']").val();
                institution = $("#form-new-team input[name='new-team-institution']").val();
                role = $("#form-new-team input[name='new-team-role']").val();

                $team[id] = {name: name, email: email, institution: institution, role: role};

                for(id in $team) {
                    user = $team[id];

                    string =  "<tr>"
                    string += "<td><input type='hidden' name='new_team_user[]' value='"+ id +"'>"+ user['name'] +"</td>"
                    string += "<td><input type='hidden' name='team_email["+ id +"]' value='"+ user['email'] +"'><a href='mailto:"+ user['email'] +"'>"+ user['email'] +"</a></td>"
                    string += "<td><input type='hidden' name='team_institution["+ id +"]' value='"+ user['institution'] +"'>"+ user['institution'] +"</td>"
                    string += "<td><input type='hidden' name='team_role["+ id +"]' value='"+ user['role'] +"'>"+ user['role'] +"</td>"
                    string += "<td><input type='hidden' name='team_name["+ id +"]' value='"+ user['name'] +"'></td>"
                    string += "<td><label class='label label-default'>{% trans %}No{% endtrans %}</label></td>"
                    string += "<td><a href='#' class='btn btn-default btn-xs button-remove-team'><i class='glyphicon glyphicon-trash'></i></a></td>"
                    string += "</tr>";

                    $("#table-team tbody").append(string);
                    $team = {};

                    form = $("#form-team");
                    form.submit();
                }
            });

            $(document).on('keypress click', '.button-remove-team', function(e){
                e.preventDefault();

                parent = $(this).parents('tr');
                parent.remove();

                form = $("#form-team");
                form.submit();
            });
        });

        // making investigator owner
        $(function(){
            $("#table-team").on("click", ".button-make-owner", function(e){
                e.preventDefault();

                parent = $(this).parents('tr');
                id = parent.data('id');

                input = "<input type='hidden' name='team-new-owner' value='"+ id +"'>";

                form = $("#form-team");
                form.prepend(input);
                form.submit();
            });
        });

        // investigators list order by ascending
        $(function(){
            $('#select-team-email').on('loaded.bs.select', function (e, clickedIndex, isSelected, previousValue) {
                var options = $(this).find("option");

                options.sort(function(a,b) {
                    if (a.text > b.text) return 1;
                    else if (a.text < b.text) return -1;
                    else return 0;
                });

                $(this).empty().append(options).selectpicker("refresh");
            });
        });

        $(function(){
            $("#modal-tab1").on("click", function(e){
                $("#team-submit").parent().removeClass('hide');
                $("#new-team-submit").parent().addClass('hide');
            });

            $("#modal-tab2").on("click", function(e){
                $("#team-submit").parent().addClass('hide');
                $("#new-team-submit").parent().removeClass('hide');
            });
        });

        $(function(){
            $("#new-team-username").on('blur', function() {
                var val = $(this).val();
                var slug = convertToSlug(val);
                $(this).val(slug);
            });
        });

        function convertToSlug(Text) {
            var from = "ÁÄÂÀÃÅČÇĆĎÉĚËÈÊẼĔȆĞÍÌÎÏİŇÑÓÖÒÔÕØŘŔŠŞŤÚŮÜÙÛÝŸŽáäâàãåčçćďéěëèêẽĕȇğíìîïıňñóöòôõøðřŕšşťúůüùûýÿžþÞĐđßÆa";
            var to   = "AAAAAACCCDEEEEEEEEGIIIIINNOOOOOORRSSTUUUUUYYZaaaaaacccdeeeeeeeegiiiiinnooooooorrsstuuuuuyyzbBDdBAa";

            for (var i=0, l=from.length ; i<l ; i++) {
                Text = Text.replace(new RegExp(from.charAt(i), 'g'), to.charAt(i));
            }

            return Text
                .toLowerCase()
                .replace(/ /g,'-')
                .replace(/_/g,'-')
                .replace(/[^\w-]+/g,'')
                ;
        }
        function copiarHref(elemento) {
            const texto = elemento.getAttribute('href'); // pega o conteúdo do href
            navigator.clipboard.writeText(texto) // usa a API moderna de clipboard
                .then(() => {
                    alert('ProEthos —\n\n' +
                        'Copied ' + texto);
                })
                .catch(err => {
                    console.error('Erro ao copiar:', err);
                    alert('Não foi possível copiar o link.');
                });
        }
    </script>
{% endblock %}