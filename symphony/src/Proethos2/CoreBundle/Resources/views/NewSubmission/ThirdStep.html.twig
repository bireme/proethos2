{% extends "::base.html.twig" %}

{% block title %}{% trans %}New submission{% endtrans %}{% endblock %}

{% block content %}
    <div class="container-fluid main-content">
        <div class="row">
            <div class='col-md-12'>
                <h1 class="page-header">{% trans %}New submission{% endtrans %}</h1>
            </div>
        </div>

        {% include 'Proethos2CoreBundle:NewSubmission:meta.html.twig' %}

        <div class='new-submission-tab-content'>
            <form class='form' method='POST' action='{{ path("submission_new_third_step", {submission_id: submission.id}) }}'>

                <input type='hidden' name='submission_id' value='{{ submission.id }}'>

                <div class='block'>
                    <div class='row'>
                        <div class="col-md-12">
                            <h2 class='sub-header'>{% trans %}General description{% endtrans %}</h2>
                        </div>
                    </div>

                    <div class='row'>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="textarea-study-design">{% trans %}Study design{% endtrans %}</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <textarea rows="4" class="form-control" name='study-design' id='textarea-study-design' required>{{ submission.studyDesign }}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class='row'>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="textarea-health-condition">{% trans %}Health Condition or Problem Studied{% endtrans %}</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <textarea rows="4" class="form-control" name='health-condition' id='textarea-health-condition'>{{ submission.healthCondition }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class='block'>
                    <div class='row'>
                        <div class="col-md-12">
                            <h2 class='sub-header'>{% trans %}General description{% endtrans %}</h2>
                        </div>
                    </div>

                    <div class='row'>
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="select-gender">{% trans %}Gender{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <select class='form-control' id='select-gender' name='gender'>
                                    <option value="N" {% if submission.gender == "N" %}selected{% endif %}>{% trans %}N/A{% endtrans %}</option>
                                    <option value="M" {% if submission.gender == "M" %}selected{% endif %}>{% trans %}Male{% endtrans %}</option>
                                    <option value="F" {% if submission.gender == "F" %}selected{% endif %}>{% trans %}Female{% endtrans %}</option>
                                    <option value="B" {% if submission.gender == "B" %}selected{% endif %}>{% trans %}Both{% endtrans %}</option>
                                </select>
                            </div>
                        </div>
                        
                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="input-sample-size">{% trans %}Target sample size{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <input type="number" class="form-control" placeholder="" min="1" value="{{ submission.sampleSize }}" id='input-sample-size' name='sample-size' required>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="input-minimum-age">{% trans %}Minimum Age{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <input type="number" class="form-control" placeholder="" min="0" value="{{ submission.minimumAge }}" name='minimum-age' id='input-minimum-age' required>
                            </div>
                        </div>

                        <div class="col-md-3">
                            <div class="form-group">
                                <label for="input-maximum-age">{% trans %}Maximum Age{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <input type="number" class="form-control" placeholder="" min="0" value="{{ submission.maximumAge }}" name='maximum-age' id='input-maximum-age' required>
                            </div>
                        </div>
                    </div>

                    <div class='row'>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="textarea-inclusion-criteria">{% trans %}Inclusion criteria{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <textarea rows="5" class="form-control" id='textarea-inclusion-criteria' name='inclusion-criteria' required>{{ submission.inclusionCriteria }}</textarea>
                            </div>
                        </div>
                    </div>
                    
                    <div class='row'>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="textarea-exclusion-criteria">{% trans %}Exclusion criteria{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <textarea rows="5" class="form-control" id='textarea-exclusion-criteria' name='exclusion-criteria' required>{{ submission.exclusionCriteria }}</textarea>
                            </div>
                        </div>
                    </div>

                    <div class='row'>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="input-recruitment-init-date">{% trans %}Estimated date of initial recruitment{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <input type='date' class='form-control' id='input-recruitment-init-date' name='recruitment-init-date' value='{{ submission.recruitmentInitDate|date("Y-m-d") }}' required>
                            </div>
                        </div>
                    </div>

                    <div class='row'>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="select-recruitment-status">{% trans %}Recruitment Status{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <select class='form-control' id='select-recruitment-status' name='recruitment-status'>
                                    <option value="P" {% if submission.recruitmentStatus == "P" %}selected{% endif %}>{% trans %}Pending{% endtrans %}</option>
                                    <option value="R" {% if submission.recruitmentStatus == "R" %}selected{% endif %}>{% trans %}Recruiting{% endtrans %}</option>
                                    <option value="S" {% if submission.recruitmentStatus == "S" %}selected{% endif %}>{% trans %}Suspended{% endtrans %}</option>
                                    <option value="C" {% if submission.recruitmentStatus == "C" %}selected{% endif %}>{% trans %}Completed{% endtrans %}</option>
                                    <option value="O" {% if submission.recruitmentStatus == "O" %}selected{% endif %}>{% trans %}Other{% endtrans %}</option>
                                </select>
                            </div>
                        </div>
                    </div>
                </div>

                <div class='block'>
                    <div class='row'>
                        <div class="col-md-12">
                            <h2 class='sub-header'>{% trans %}Recruitment Countries{% endtrans %}:</h2>
                        </div>
                    </div>

                    <div class='row'>
                        <div class="col-md-12">
                            <table class='table table-hover table-condensed'>
                                
                                <thead>
                                    <tr>
                                        <th width="50%">{% trans %}Countrỳ{% endtrans %}</th>
                                        <th>{% trans %}Total of participants{% endtrans %}</th>
                                        <th>{% trans %}Actions{% endtrans %}</th>
                                    </tr>
                                </thead>
                                
                                <tbody>
                                    <tr>
                                       <td>Brasil</td> 
                                       <td><label class='label label-default'>14</label></td> 
                                       <td><a href='#' class='btn btn-default btn-xs'><i class='glyphicon glyphicon-trash'></i></a></td> 
                                    </tr>
                                    <tr>
                                       <td>Chile</td> 
                                       <td><label class='label label-default'>10</label></td> 
                                       <td><a href='#' class='btn btn-default btn-xs'><i class='glyphicon glyphicon-trash'></i></a></td> 
                                    </tr>
                                </tbody>
                            </table>
                            <a href='#' class='btn btn-default' data-toggle="modal" data-target="#modal-new-country">Novo País</a>
                        </div>
                    </div>

                    <div class='row'>
                        <div class="col-md-12">
                            <div class="form-group">
                                <label for="textarea-interventions">{% trans %}Interventions{% endtrans %}:</label> 
                                <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                                <textarea rows="4" class="form-control" id='textarea-interventions' name='interventions' required>{{ submission.interventions }}</textarea>
                            </div>
                        </div>
                    </div>
                </div>

                <div class='submission-button-controls'>
                    <button type='submit' class='btn btn-primary'>{% trans %}Save and next{% endtrans %}</button>
                </div>
            </form>
        </div>
    </div>

    <!-- Modal Novo Investigador -->
    <div class="modal fade" id="modal-new-investigator" tabindex="-1" role="dialog" aria-labelledby="myModalLabel">
        <div class="modal-dialog" role="document">
            <div class="modal-content">
                <form class='form' id='form-team'>
                    <div class="modal-header">
                        <button type="button" class="close" data-dismiss="modal" aria-label="Close"><span aria-hidden="true">&times;</span></button>
                        <h4 class="modal-title" id="myModalLabel">{% trans %}New Investigator{% endtrans %}</h4>
                    </div>
                    <div class="modal-body">
                        <div class="form-group">
                            <label for="">{% trans %}E-mail{% endtrans %}:</label> 
                            <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                            <input type='email' class='form-control' name='team-email'>
                        </div>
                        
                        <div class="form-group">
                            <label for="">{% trans %}Name{% endtrans %}:</label> 
                            <a href='#' data-toggle="modal" data-target="#modal-help"><i class='glyphicon glyphicon-question-sign'></i></a>
                            <input type='text' class='form-control' name='team-name' readonly="">
                        </div>
                    </div>
                    
                    <div class="modal-footer">
                        <button type="button" class="btn btn-default" data-dismiss="modal">{% trans %}Close{% endtrans %}</button>
                        <button type="submit" id='team-submit' class="btn btn-primary disabled" data-dismiss="modal">{% trans %}Save{% endtrans %}</button>
                    </div>
                </form>
            </div>
        </div>
    </div>
{% endblock %}

{% block script %}
    <script>
        $(function(){

            $team = {};

            $("#form-team input[name='team-email']").keyup(function() {

                email = $(this).val();
                $.post("{{ path('api_get_user_by_email') }}", {email: email}, function(data){
                    if(!$.isEmptyObject(data)) {

                        user = data[0];
                        $team[user['id']] = {name: user['name'], email: user['email'], country: user['country']};
                        
                        $("#form-team input[name='team-name']").val(user['name']);
                        $("#team-submit").removeClass('disabled');

                    } else {

                        $("#form-team input[name='team-name']").val("");
                        $("#team-submit").addClass('disabled');
                        $team = {};
                    }
                });
            });

            $("#team-submit").click(function(e){
                e.preventDefault();

                for(id in $team) {
                    user = $team[id];
                    
                    string =  "<tr>"
                    string += "<td><input type='hidden' name='team_user[]' value='"+ id +"'>"+ user['name'] +"</td>"
                    string += "<td><a href='mailto:"+ user['email'] +"'>"+ user['email'] +"</a></td>"
                    string += "<td>"+ user['country'] +"</td>"
                    string += "<td><label class='label label-default'>Não</label></td>"
                    string += "<td><a href='#' class='btn btn-default btn-xs'><i class='glyphicon glyphicon-trash'></i></a></td>"
                    string += "</tr>";

                    $("#table-team tbody").append(string);
                }
            });

            $(".button-remove-team").click(function(e){
                e.preventDefault();

                parent = $(this).parents('tr');
                console.log(parent);
                parent.remove();
            });
        });
    </script>
{% endblock %}
